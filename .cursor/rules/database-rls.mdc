description: DATABASE / RLS / SQL. Apply for Postgres security policies, Supabase migrations, GRANT/REVOKE, SECURITY DEFINER functions, foreign keys, indices, 403/permission denied errors.
alwaysApply: false
globs: ["**/*.sql", "**/migrations/**", "**/supabase/**"]
lastReviewed: 2025-01-15

# Database RLS Patterns

# ðŸ”´ CRITICAL PRIORITY

## [P1] RLS Policy 403 Errors - Fixed
- **Error**: 403 Forbidden on all database operations (inventory, orgs, notifications)
- **Error Signature**: `new row violates row-level security policy` or `permission denied for table` or `Authorization header present, but table access denied before RLS evaluation`
- **Root Cause**: Two distinct issues:
  1. RLS policies on `inventory` and `orgs` were querying `memberships` table via EXISTS subqueries, but `memberships` table RLS was blocking those checks. Also, policies used inconsistent roles (`public` vs `authenticated`).
  2. **Missing GRANT permissions**: Tables have RLS policies but missing `GRANT SELECT/INSERT/UPDATE/DELETE ON table TO authenticated` statements, causing 403 before RLS evaluation.
- **Fix Applied**: 
  - Created `is_org_member(org_id, user_id)` SECURITY DEFINER function to bypass RLS on memberships checks
  - Updated all RLS policies to use `authenticated` role consistently
  - Replaced EXISTS subqueries with `is_org_member()` function calls
  - **Added GRANT permissions**: Required after Supabase v2.0 changed default permissions. RLS policies alone are insufficient without explicit GRANTs.
    - `GRANT SELECT, INSERT, UPDATE, DELETE ON public.inventory TO authenticated;`
    - `GRANT UPDATE ON public.orgs TO authenticated;`
    - `GRANT UPDATE ON public.master_products TO authenticated;`
    - `GRANT INSERT, UPDATE, DELETE ON public.notifications TO authenticated;`
  - Applied migrations: `fix_rls_policies_memberships_access`, `add_membership_check_function`, `update_orgs_select_policy`, `grant_inventory_permissions_to_authenticated`, `grant_orgs_update_permission_to_authenticated`, `grant_missing_permissions_master_products_notifications`
- **Prevention**: 
  - Always use SECURITY DEFINER functions for cross-table RLS checks
  - Ensure consistent role usage (`authenticated` for user data, `public` only for truly public data)
  - **When creating RLS policies, ALWAYS include corresponding GRANT statements**: `GRANT SELECT, INSERT, UPDATE, DELETE ON table_name TO authenticated;`
  - **Checklist for new RLS policies**: For each operation (SELECT/INSERT/UPDATE/DELETE) in the policy, ensure matching GRANT exists
  - **Verification query** to find missing grants:
    ```sql
    SELECT p.tablename, p.cmd as operation
    FROM pg_policies p
    WHERE p.schemaname = 'public'
      AND p.cmd IN ('INSERT', 'UPDATE', 'DELETE')
      AND p.roles::text LIKE '%authenticated%'
      AND NOT EXISTS (
        SELECT 1 FROM information_schema.role_table_grants rtg
        WHERE rtg.table_name = p.tablename
        AND rtg.grantee = 'authenticated'
        AND rtg.privilege_type = p.cmd
      )
    GROUP BY p.tablename, p.cmd;
    ```
  - **Fixed tables**: inventory (SELECT/INSERT/UPDATE/DELETE), orgs (UPDATE), master_products (UPDATE), notifications (INSERT/UPDATE/DELETE)

## [P1] Supabase Migrations & DDL
- **Error**: `ERROR: 25006: cannot execute CREATE TABLE in a read-only transaction`
- **Context**: The Supabase MCP connection is read-only for DDL.
- **Fix**: Use the Supabase CLI for migrations.
  - Create migration: `npm run supabase:migration:new <migration_name>`
  - Apply migration: `npx supabase db push --linked`
- **Prevention**: ALWAYS use the CLI for DDL changes. MCP is for data queries.

## [P2] Empty `database.ts`
- **Error**: `File '.../database.ts' is not a module`, causing widespread TypeScript errors.
- **Context**: `database.ts` is empty after a migration.
- **Fix**: Regenerate types: `mcp_supabase_generate_typescript_types()`. Ensure the output file is not empty.
- **Prevention**: Regenerate types after every migration.

## Org Lifecycle & Context Invariants
- **Lifecycle states**: `onboarding_pending`, `active`, `suspended`, `archived`. Only org owners with `onboarding_pending` hit `/setup`; completion must flip the state to `active`.
- **Single owner per org**: enforced via partial unique index on `(org_id, role)` for `org_owner`. Ownership transfers must go through a dedicated RPC for auditing.
- **Org context storage**: `user_org_contexts` table + `set_current_org_context(uuid)` keep Postgres helpers (`current_user_org_id`, `current_user_role`, branch helpers) in sync with the client's `currentOrgContext`. Always call the RPC when switching orgs.
- **Multi-org switcher**: The header switcher is the only supported way to pick an org/agent context. All UI/RPC code must consume `currentOrgContext`/`currentAgentContext`, never raw `user.orgId`.
- **Start vs join flows**: "Start a new business" calls `create_default_org_for_user` (owner-only) from the switcher or settings. "Join existing organization" lives at `/join-org` and requires an inviteâ€”no auto-org creation on login. Legacy `test-*` orgs must stay `archived`.

## Related Rules
- `@deployment.mdc` â€” Covers build and CI steps that often accompany schema migrations.
- `@security.mdc` â€” Works in tandem when policies intersect with auth, MFA, and user verification.
- `@learned-rules.mdc` â€” Provides the DRY and verification principles that guide database changes.
