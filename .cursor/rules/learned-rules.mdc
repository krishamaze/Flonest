---
alwaysApply: true
---
# FineTune Business Application - Learned Rules

**Project Context**: Next.js/Vite PWA inventory management system with Supabase backend

Always learn from execution errors.
Whenever an error occurs â€” in build, runtime, or logic â€” capture the error context, record its signature, and update this file to prevent repetition.

### Primary Rule â€” No Temporary Patches
- "Temporary patches become permanent debt."
- Never ship quick fixes; every change must be a durable, production-grade solution.

## Maintenance Policy
- This file must stay concise (<500 lines)
- Remove outdated/irrelevant sections regularly
- Keep only errors relevant to this specific project
- Expand by reference, not inline
- **Priority System**: Errors are ranked by frequency/impact (ðŸ”´ Critical â†’ ðŸŸ¡ Medium â†’ ðŸŸ¢ Low)
- **When error recurs**: Move it up in priority, increment occurrence count
- **Review monthly**: Demote errors that haven't occurred recently

---

# ðŸ”´ CRITICAL PRIORITY (Recurring/High Impact)

These errors occur frequently or have severe consequences. **Always check these first.**

## [Priority 1] Supabase MCP Read-Only DDL Error
**Error Signature**: `ERROR: 25006: cannot execute CREATE TABLE in a read-only transaction`
**Context**: Supabase MCP connection is read-only and cannot execute DDL operations
**Fix**: Use Supabase CLI for migrations: `npx supabase db push --linked`
**Pattern**: Create files with `npm run supabase:migration:new`, apply with CLI (NOT MCP)
**Prevention**: Always use Supabase CLI for migrations. MCP is read-only for DDL.

## [Priority 1] Vercel Deployment Not Updating After Push
**Error Signature**: Code pushed but Vercel still shows BUILDING or old version
**Context**: Not verifying deployment status after push
**Fix**: Use Vercel MCP `list_deployments` â†’ `get_deployment` to check state. Wait until READY (not BUILDING). Check `get_deployment_build_logs` if ERROR.
**Prevention**: Always verify deployment reaches READY state after push.

## [Priority 1] Security Always Trumps Convenience
**Principle**: Security best practices must NEVER be compromised for UX convenience
**Context**: When implementing auth/security features (password reset, login, signup, etc.)
**Examples**:
- âœ… Generic password reset messages (prevents email enumeration)
- âœ… Generic signup success messages (don't reveal SMTP/email configuration)
- âœ… Rate limiting on sensitive endpoints
- âœ… Proper error handling that doesn't leak system info
- âŒ Revealing which emails are registered
- âŒ Revealing SMTP configuration status ("email confirmation not configured")
- âŒ Showing detailed error messages that help attackers
- âŒ Skipping validation for "better UX"
**Rule**: If a security decision seems inconvenient, that's usually the correct choice. Always choose security over convenience.
**Pattern**: 
```typescript
// âœ… GOOD - Generic message (secure)
setMessage('If an account exists with this email, you will receive password reset instructions.')

// âœ… GOOD - Signup success (doesn't reveal email confirmation status)
setMessage('Account created successfully! If email confirmation is required, please check your email for further instructions.')

// âŒ BAD - Reveals email existence (insecure but "convenient")
if (!userExists) {
  setError('This email is not registered. Please sign up first.')
}

// âŒ BAD - Reveals SMTP configuration (information leak)
if (data.user && !data.session) {
  setMessage('Account created! However, email confirmation is not configured. Please contact support.')
}
```
**Prevention**: When implementing auth features, research industry-standard security practices first. Default to more secure, even if less convenient. Always use generic messages that work for all scenarios.

## [Priority 2] Empty database.ts Causing Cascading TypeScript Errors
**Error Signature**: `File 'D:/biz.finetune.store/src/types/database.ts' is not a module`, hundreds of type errors across codebase
**Context**: After database migrations, `database.ts` is empty or not regenerated, causing all Supabase queries to fail type checking
**Fix**: Regenerate types using Supabase MCP: `mcp_supabase_generate_typescript_types()`. Extract from JSON response: `$json = Get-Content <file> -Raw | ConvertFrom-Json; $json.types | Set-Content 'src\types\database.ts'`. Verify file has content before pushing.
**Pattern**: After ANY migration, regenerate types immediately. Check `database.ts` has proper `export type Database = {...}` content.
**Prevention**: Always regenerate types after migrations. Verify types file is not empty before building. Add to deployment checklist: "Check database.ts has content".

## [Priority 2] View Not Scrollable
**Error Signature**: Page content appears but cannot scroll, content cut off below viewport
**Context**: Parent container has `overflow: hidden`, fixed height without scroll, or `min-h-screen` on main content forcing full viewport height with fixed header/footer
**Fix**: Remove `min-h-screen` from main content when using fixed header/footer. Check parent containers for `overflow: hidden`. Ensure main content wrapper has `overflow-y: auto` or natural height. Remove fixed heights that constrain scrollable area.
**Prevention**: Avoid `min-h-screen` on content between fixed header/footer. Test scroll behavior on mobile viewports.

## [Priority 2] React State Not Updating After Async Operation
**Error Signature**: State setter called but UI doesn't update, or stale state in callback
**Context**: Using state value immediately after `setState()` or stale closure
**Fix**: Use functional updates `setState(prev => prev + 1)` for dependent state. Use `useEffect` to react to state changes. Don't read state immediately after setting.
**Prevention**: Use functional updates for dependent state. Remember `setState` is async.

## [Priority 2] Supabase Query Returns Unexpected null/undefined
**Error Signature**: `Cannot read property 'X' of null` when accessing query result
**Context**: Supabase returns `{ data: null, error }` on error or `data: []` for empty
**Fix**: Always check `error` first, then check if `data` exists and non-empty. Use optional chaining `data?.property`.
**Prevention**: Always destructure both `data` and `error`. Check `error` before accessing `data`.

## [Priority 3] Supabase RLS Permission Denied
**Error Signature**: `new row violates row-level security policy`
**Context**: User doesn't meet RLS policy conditions or policy missing
**Fix**: Check RLS policies in Supabase Dashboard. Ensure user authenticated and meets policy conditions (e.g., `auth.uid() = user_id`). Use service role key for backend operations.
**Prevention**: Define RLS policies when creating tables. Test with actual user auth.

## [Priority 3] Supabase Partial Unique Index Constraint Error
**Error Signature**: `there is no unique or exclusion constraint matching the ON CONFLICT specification`
**Context**: Using `upsert` with `onConflict` on columns that have partial unique indexes (not full unique constraints)
**Fix**: Replace `upsert` with find-then-update-or-insert pattern. Query existing record first, then update or insert accordingly
**Pattern**: 
```typescript
// Instead of: .upsert({ ... }, { onConflict: 'column' })
// Use:
const { data: existing } = await supabase
  .from('table')
  .select()
  .eq('column', value)
  .single();

if (existing) {
  await supabase.from('table').update({ ... }).eq('id', existing.id);
} else {
  await supabase.from('table').insert({ ... });
}
```
**Prevention**: Check database schema for partial unique indexes before using upsert

---

# ðŸŸ¡ MEDIUM PRIORITY (Occasional/Moderate Impact)

These errors occur occasionally during development or specific scenarios.

## [Priority 4] Git User Configuration - Vercel Team Access Denied
**Error Signature**: `403 Forbidden` when Vercel deploys
**Context**: Git commits with email not associated with Vercel team
**Fix**: Configure git: `git config user.email "finetunetech.e@gmail.com"`
**Prevention**: Verify git config matches team email before committing.

## [Priority 4] MainLayout Component Children Not Supported
**Error Signature**: `Type '{ children: Element; title: string; }' is not assignable to type 'IntrinsicAttributes'. Property 'children' does not exist`
**Context**: New pages wrap content in `<MainLayout>` component, but MainLayout uses `<Outlet />` and doesn't accept children
**Fix**: Remove MainLayout wrapper from page components. Pages should return content directly - routing handles the layout. Replace `<MainLayout title="X"><content></MainLayout>` with just `<div className="pb-20"><content></div>`.
**Pattern**: Other pages (ProductsPage, CustomersPage, etc.) don't wrap themselves in MainLayout. Check existing pages for correct structure.
**Prevention**: When creating new pages, check how existing pages are structured. MainLayout is applied at routing level, not component level.

## [Priority 4] Branch Merge Confusion - Two Separate Projects
**Error Signature**: Merge conflicts, wrong Vercel project deployment
**Context**: Two branches (`main` = PWA app, `marketing` = marketing site) deploy to separate Vercel projects
**Fix**: Work on correct branch, push directly. NEVER merge branches.
**Prevention**: Keep `main` and `marketing` branches completely isolated.

## [Priority 5] Edge Function Required for MFA Enrollment
**Error Signature**: `mfa.challenge()` / `mfa.verify()` timeouts, duplicate/unverified factors, admins accessing platform dashboard with `aal1`
**Context**: Platform admin MFA flow ran entirely in the browser. Network timeouts and retries created orphaned factors and failed to upgrade sessions to AAL2.
**Fix**: Move the enrollment + verification flow into a Supabase Edge Function (`admin-mfa-enroll`) using service-role credentials plus exponential-backoff retries, exposing `/start` and `/verify` endpoints to the client.
**Prevention**: For privileged auth flows, orchestrate all Supabase Auth operations server-side. The client should only call trusted endpoints (Edge Functions) instead of hitting `mfa.*` APIs directly.

## [Priority 5] Service Worker Not Detecting Updates
**Error Signature**: New deployment live but no update notification on pull-to-refresh
**Context**: Service worker registration or update check failing
**Fix**: Verify SW registered in `src/main.tsx`. Check `PullToRefresh.tsx` calls `serviceWorkerRegistration.update()`. Check browser console for SW errors.
**Prevention**: Service worker auto-detects bundle hash changes. Ensure SW registered and `update()` called on pull-to-refresh.

## [Priority 5] Pull-to-Refresh Interfering with Scroll
**Error Signature**: Page scrolls unexpectedly or refresh triggers during normal scroll
**Context**: Touch event listeners conflicting with native scroll
**Fix**: Only trigger when `window.scrollY === 0`. Add threshold (80px+) before refresh. Prevent default only when actually pulling to refresh.
**Prevention**: Check scroll position before handling touch events. Use thresholds to avoid accidental triggers.

## [Priority 6] Supabase Type Generation Workflow (MCP Method)
**Error Signature**: `supabase gen types` CLI fails with `.env parsing error` or authentication issues
**Context**: Need to regenerate types after migrations, but CLI has environment issues
**Fix**: Use Supabase MCP instead of CLI. Call `mcp_supabase_generate_typescript_types()` â†’ extracts to temp file. Use PowerShell to extract JSON: `$json = Get-Content <temp-file> -Raw | ConvertFrom-Json; $json.types | Set-Content 'src\types\database.ts' -Encoding UTF8`.
**Pattern**:
```powershell
# 1. Call Supabase MCP (returns JSON-wrapped types to temp file)
# 2. Create extract-types.ps1:
$json = Get-Content '<temp-file-path>' -Raw | ConvertFrom-Json
$json.types | Set-Content 'src\types\database.ts' -Encoding UTF8
Write-Host "Types extracted successfully"

# 3. Run script:
powershell -ExecutionPolicy Bypass -File extract-types.ps1

# 4. Verify file has content:
Get-Content src\types\database.ts -TotalCount 5

# 5. Test build:
npm run build
```
**Prevention**: Prefer Supabase MCP over CLI when in Cursor. MCP is more reliable and doesn't require .env file. Clean up temp script after use.

## [Priority 6] TypeScript Type Errors in Build
**Error Signature**: Build fails with TypeScript type errors
**Context**: Type mismatches, missing types, or incorrect type imports
**Fix**: Check imports, verify Supabase types (`npm run supabase:types`), use proper React types
**Prevention**: Enable strict TypeScript checking and fix errors during development

---

# ðŸŸ¢ LOW PRIORITY (Rare/Minor Impact)

These errors are rare or have minimal impact on development workflow.

## [Priority 7] Variable Scope Error
**Error Signature**: `ReferenceError: X is not defined`
**Context**: Variables declared inside `if` blocks not accessible outside
**Fix**: Move variable declarations outside conditional blocks
**Prevention**: Declare variables at appropriate scope level

## [Priority 7] PowerShell Token Parsing Error
**Error Signature**: PowerShell syntax errors with string interpolation
**Context**: Unescaped quotes, missing backticks (Windows development)
**Fix**: Use proper PowerShell escaping
**Prevention**: Test PowerShell commands in terminal before adding to scripts

## [Priority 8] Vite Build Output Directory Errors
**Error Signature**: Build succeeds but deployment fails to find files
**Context**: Vercel looking for files in wrong directory
**Fix**: Ensure `vercel.json` has correct `outputDirectory: "dist"`
**Prevention**: Test build locally before pushing