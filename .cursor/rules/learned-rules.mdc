description: CODE QUALITY / PATTERNS. Apply when user requests refactoring, DRY enforcement, linting, testing discipline, best practices for code structure, duplication removal, state management, context usage, or architecture simplification.
alwaysApply: false
lastReviewed: 2025-11-20
# Primary Rules

**Quality Standards:**
- Prioritize security and simplicity‚Äîno overengineering

**DRY Principle (Don't Repeat Yourself):**
- Before writing new code, search for existing implementations
- Reuse and refactor rather than duplicate
- If you find duplication, consolidate it
- Shared logic belongs in utilities, helpers, or services

**DRY Examples:**

```typescript
// ‚ùå BAD: Duplicated logic
function calculateTaxA(amount: number) {
  return amount * 0.15;
}

function calculateTaxB(amount: number) {
  return amount * 0.15;
}

// ‚úÖ GOOD: Shared utility
function calculateTax(amount: number, rate = 0.15) {
  return amount * rate;
}

// ‚ùå BAD: Duplicated validation
function validateEmailA(email: string) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function validateEmailB(email: string) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

// ‚úÖ GOOD: Shared utility
function validateEmail(email: string): boolean {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}
```

**Context & Provider Integrity:**
- **Explicit Contracts:** Context Interfaces MUST explicitly define all properties and methods they expose.
- **Export Types:** Always export the Context Type from the provider file so consumers (hooks) can reference it.
- **Sync Check:** When modifying a Provider's values, immediately update the Interface definition.
- **No Hidden Props:** Never rely on `any` or implicit typing for context values; this causes build failures in strict mode.

**State Management Patterns:**
- **Identity Provider Ownership:** `IdentitySheetProvider` (and similar root providers) must strictly own all state, history logic, and transition locks. Child components must be pure consumers.
- **Timestamp Lock:** Use `transitionUntil` timestamp refs (e.g., `useRef(Date.now())`) for interaction locking instead of boolean flags to prevent race conditions.
- **History Sync:** Manual sheet closures or navigation events must use `history.back()` to stay in sync with the browser's `popstate` logic.

**Verification (DRY applies here):**
- Always verify the current state of the codebase, db, and backend before making changes
- Search for existing implementations (functions, components, queries, patterns)
- Confirm your understanding and show evidence of what you found
- Never assume - always check first
- If not 90% certain, ask for clarification with specific questions

**Communication:**
- Keep replies concise and confident
- Speak collaboratively, not dictatorially

**Learning System:**
Extract lessons from all execution errors:
- Capture: full context, error signature, reproduction steps
- Document in: 
  - `.cursor/rules/database-rls.mdc` (for RLS/database errors)
  - `.cursor/rules/deployment.mdc` (for deployment/build errors)
  - `.cursor/rules/security.mdc` (for auth/security issues)
  - `.cursor/rules/performance.mdc` (for UI/performance issues)
  - `.cursor/rules/design-system.mdc` (for UI/design patterns)
- Format: Priority (üî¥üü°üü¢) + Count + Last Seen + Solution
- Maintain: Remove outdated content monthly, keep project-specific only
- Update: Increase priority for repeated errors

**Scope Management:**
- Stay within task boundaries unless explicitly expanding
- All changes must be reversible with documented rollback
- Flag scope creep early

## Related Rules
- `@design-system.mdc` ‚Äî Applies the same quality principles to UI tokens and components.
- `@database-rls.mdc`, `@deployment.mdc`, `@security.mdc`, `@performance.mdc` ‚Äî Domain-specific lessons referenced from this learning system.
- `@00-project-context.mdc` ‚Äî Senior Dev identity enforcing these standards during execution.
